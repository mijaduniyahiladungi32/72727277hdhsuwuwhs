name: Merge M3U Playlists

on:
  schedule:
    - cron: "*/15 * * * *"   # Every 15 minutes
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Download External Repos
        run: |
          echo "Cloning source repositories..."
          git clone --depth=1 https://${{ secrets.SOURCE_URL1 }} temp1
          git clone --depth=1 https://${{ secrets.SOURCE_URL2 }} temp2
          mkdir -p merged
          cp -r temp1/*.m3u merged/ || true
          cp -r temp1/*.m3u8 merged/ || true
          cp -r temp2/*.m3u merged/ || true
          cp -r temp2/*.m3u8 merged/ || true
          cp -r ./*.m3u merged/ || true
          cp -r ./*.m3u8 merged/ || true

      - name: Merge Playlists
        run: |
          echo "#EXTM3U" > All-playlist.m3u
          for f in merged/*.m3u merged/*.m3u8; do
            [ -f "$f" ] || continue
            fname=$(basename "$f")
            # Remove extension
            fname_noext="${fname%.*}"
            # Escape sed special chars
            esc_fname=$(printf '%s\n' "$fname_noext" | sed 's/[\/&]/\\&/g')
            while IFS= read -r line; do
              if [[ "$line" == \#EXTINF* ]]; then
                if [[ "$line" =~ group-title=\"([^\"]+)\" ]]; then
                  oldgroup="${BASH_REMATCH[1]}"
                  esc_oldgroup=$(printf '%s\n' "$oldgroup" | sed 's/[\/&]/\\&/g')
                  # Use | as delimiter to avoid / conflicts
                  newline=$(echo "$line" | sed "s|group-title=\"[^\"]*\"|group-title=\"${esc_fname} | ${esc_oldgroup}\"|")
                  echo "$newline" >> All-playlist.m3u
                else
                  newline=$(echo "$line" | sed "s|#EXTINF:|#EXTINF: group-title=\"${esc_fname}\" ,|")
                  echo "$newline" >> All-playlist.m3u
                fi
              else
                echo "$line" >> All-playlist.m3u
              fi
            done < "$f"
          done

      - name: Clone target private repository
        run: |
          git clone https://x-access-token:${{ secrets.TARGET_TOKEN }}@${{ secrets.TARGET_URL }} ${{ secrets.TARGET_NAME }}

      - name: Copy playlist to target repository
        run: cp All-playlist.m3u ${{ secrets.TARGET_NAME }}/All-playlist.m3u

      - name: Commit & push to target repository
        run: |
          cd ${{ secrets.TARGET_NAME }}
          git config user.name "${{ secrets.TARGET_REPO_USER }}"
          git config user.email "${{ secrets.TARGET_REPO_USER }}@users.noreply.github.com"
          git add All-playlist.m3u
          git commit -m "ðŸ”„ Auto update playlist on $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push
